name: Build Jekyll Site with Docker Fallbacks

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Verify Gemfile
        run: |
          if [ ! -f Gemfile ]; then
            echo "::error::Gemfile not found in repository root!"
            exit 1
          fi
          echo "✅ Found Gemfile:"
          head -n 10 Gemfile

      - name: Build Jekyll (Docker & Native Fallbacks)
        run: |
          set -euo pipefail

          build_jekyll() {
            set -euo pipefail
            echo "::group::Attempting build with: $1"
            case "$1" in
              jekyll-docker)
                docker run --rm \
                  -v "$PWD:/srv/jekyll" \
                  -w /srv/jekyll \
                  jekyll/jekyll:latest \
                  sh -c "chown -R jekyll:jekyll /srv/jekyll && \
                         bundle install --jobs 4 --retry 3 && \
                         JEKYLL_ENV=production bundle exec jekyll build --trace --destination /srv/jekyll/_site"
                ;;
              jekyll-builder)
                docker run --rm \
                  -v "$PWD:/srv/jekyll" \
                  -w /srv/jekyll \
                  jekyll/builder:latest \
                  sh -c "chown -R jekyll:jekyll /srv/jekyll && \
                         bundle install --jobs 4 --retry 3 && \
                         JEKYLL_ENV=production bundle exec jekyll build --trace --destination /srv/jekyll/_site"
                ;;
              ruby-native)
                sudo apt-get update -qq
                sudo apt-get install -y ruby-full build-essential zlib1g-dev
                export GEM_HOME="$HOME/.gem/ruby/$(ruby -e 'print RUBY_VERSION[/\d+\.\d+/]')"
                export PATH="$GEM_HOME/bin:$PATH"
                gem install --no-document bundler
                bundle config set path vendor/bundle
                bundle install --jobs 4 --retry 3
                JEKYLL_ENV=production bundle exec jekyll build --trace --destination _site
                ;;
              *)
                echo "::error::Unknown build mode: $1"
                exit 1
                ;;
            esac
            echo "::endgroup::"
          }

          success=0
          for method in jekyll-docker jekyll-builder ruby-native; do
            if build_jekyll "$method" && [ -d "_site" ]; then
              success=1
              echo "✅ Build succeeded with $method"
              break
            else
              echo "⚠️ Build failed with $method, trying next..."
            fi
          done

          if [ $success -ne 1 ]; then
            echo "::error::All build methods failed — no site generated."
            exit 1
          fi

          echo "✅ _site generated:"
          ls -lah _site

      - uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
